<!-- Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<!-- Iron components -->
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<!-- Paper components -->
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<!-- Other components -->
<link rel="import" href="../bower_components/juicy-ace-editor/juicy-ace-editor.html">
<!-- JS Libraries -->
<link rel="import" href="./event-emitter.html">
<script type="text/javascript" src="../libs/xterm/xterm.js"></script>
<script type="text/javascript" src="../libs/xterm/addons/fit/fit.js"></script>

<dom-module id="mp-ide">
    <template>
        <style>
            :host {
                display: block;
                background: #1e1e1e;
            }
            .header {
                width: 100%;
                height: 60px;
                background: rgba(0, 0, 0, 0.2);
            }
            .editor {
                width: 100%;
                height: calc(100vh - 160px);
            }
            .console {
                width: 100%;
                height: 100px;
                color: white;
                background: black;
            }
            .header {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
            }
            .header paper-fab {
                display: inline-block;
                margin: 0 5px;
                --paper-fab-background: var(--google-yellow-500);
            }
            .header .separator {
                width: 15px;
                height: 100%;
            }
            #fileToUpload {
                color: white;
            }
            paper-spinner, paper-spinner-lite {
                margin: 5px;
                 --paper-spinner-stroke-width: 6px;
                 --paper-spinner-color: var(--google-yellow-500);
            }
            .xterm {
                font-family: courier-new, courier, monospace;
                font-feature-settings: "liga" 0;
                position: relative;
                user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
            }

            .xterm.focus,
            .xterm:focus {
                outline: none;
            }

            .xterm .xterm-helpers {
                position: absolute;
                top: 0;
                /**
                 * The z-index of the helpers must be higher than the canvases in order for
                 * IMEs to appear on top.
                 */
                z-index: 10;
            }

            .xterm .xterm-helper-textarea {
                /*
                 * HACK: to fix IE's blinking cursor
                 * Move textarea out of the screen to the far left, so that the cursor is not visible.
                 */
                position: absolute;
                opacity: 0;
                left: -9999em;
                top: 0;
                width: 0;
                height: 0;
                z-index: -10;
                /** Prevent wrapping so the IME appears against the textarea at the correct position */
                white-space: nowrap;
                overflow: hidden;
                resize: none;
            }

            .xterm .composition-view {
                /* TODO: Composition position got messed up somewhere */
                background: #000;
                color: #FFF;
                display: none;
                position: absolute;
                white-space: nowrap;
                z-index: 1;
            }

            .xterm .composition-view.active {
                display: block;
            }

            .xterm .xterm-viewport {
                /* On OS X this is required in order for the scroll bar to appear fully opaque */
                background-color: #000;
                overflow-y: scroll;
                cursor: default;
                position: absolute;
                right: 0;
                left: 0;
                top: 0;
                bottom: 0;
            }

            .xterm .xterm-screen {
                position: relative;
            }

            .xterm .xterm-screen canvas {
                position: absolute;
                left: 0;
                top: 0;
            }

            .xterm .xterm-scroll-area {
                visibility: hidden;
            }

            .xterm .xterm-char-measure-element {
                display: inline-block;
                visibility: hidden;
                position: absolute;
                left: -9999em;
            }

            .xterm.enable-mouse-events {
                /* When mouse events are enabled (eg. tmux), revert to the standard pointer cursor */
                cursor: default;
            }

            .xterm:not(.enable-mouse-events) {
                cursor: text;
            }

            .xterm .xterm-accessibility,
            .xterm .xterm-message {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                right: 0;
                z-index: 100;
                color: transparent;
            }

            .xterm .xterm-accessibility-tree:focus [id^="xterm-active-item-"] {
                outline: 1px solid #F80;
            }

            .xterm .live-region {
                position: absolute;
                left: -9999px;
                width: 1px;
                height: 1px;
                overflow: hidden;
            }
        </style>
        <div class="header">
            <template is="dom-if" if="[[!connected]]">
                <paper-fab
                    on-tap="connect"
                    icon="hardware:developer-board"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="loadAvailableDevices"
                    icon="icons:refresh"
                    mini>
                </paper-fab>
                <select id="serialPorts">
                    <template is="dom-repeat" items="[[availableDevices]]">
                        <option value="[[item.comName]]">[[item.comName]]</option>
                    </template>
                </select>
            </template>
            <template is="dom-if" if="[[connected]]">
                <paper-fab
                    on-tap="disconnect"
                    icon="hardware:developer-board"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="run"
                    icon="av:play-arrow"
                    disabled="[[running]]"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="stop"
                    icon="av:stop"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="reset"
                    icon="av:replay"
                    mini>
                </paper-fab>
                <div class="separator"></div>
                <paper-fab
                    on-tap="listFiles"
                    icon="icons:folder"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="openSaveDialog"
                    icon="icons:file-upload"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="openLoadDialog"
                    icon="icons:file-download"
                    mini>
                </paper-fab>
                <paper-fab
                    on-tap="openRemoveDialog"
                    icon="icons:delete-forever"
                    mini>
                </paper-fab>
            </template>
            <template is="dom-if" if="[[connecting]]">
                <paper-spinner-lite active="[[connecting]]"></paper-spinner-lite>
            </template>
        </div>
        <juicy-ace-editor
            id="code"
            class="editor"
            fontsize="13"
            softtabs="true"
            mode="ace/mode/python"
            theme="ace/theme/clouds"
            on-change="autosaveCode"
            value="[[code]]">
        </juicy-ace-editor>
        <div id="console" class="console"></div>
        <!-- <div id="console" class="console"><code><pre>[[consoleOut]]</pre></code></div> -->
        <paper-dialog id="saveDialog" modal>
            <h2>Save as</h2>
            <paper-input id="saveFilename" always-float-label label="File name"></paper-input>
            <div class="buttons">
                <paper-button autofocus dialog-dismiss>Cancel</paper-button>
                <paper-button on-tap="saveFile">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="loadDialog" modal>
            <h2>Load file</h2>
            <paper-input id="loadFilename" always-float-label label="File name"></paper-input>
            <div class="buttons">
                <paper-button autofocus dialog-dismiss>Cancel</paper-button>
                <paper-button on-tap="loadFile">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="removeDialog" modal>
            <h2>Remove file</h2>
            <paper-input id="removeFilename" always-float-label label="File name"></paper-input>
            <div class="buttons">
                <paper-button autofocus dialog-dismiss>Cancel</paper-button>
                <paper-button on-tap="removeFile">OK</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        class MicroPythonIDE extends Polymer.Element {
            static get is() {
              return 'mp-ide';
            }
            static get properties() {
                return {
                    /**
                    * All available serial ports
                    */
                    availablePorts: {
                        type: Array,
                        value: () => []
                    },
                    /**
                    * All serial ports that pass the filter `computeAvailableDevices`
                    */
                    availableDevices: {
                        type: Array,
                        computed: 'computeAvailableDevices(availablePorts.*)'
                    },
                    /**
                    * Communication channel between front end and platform
                    * specific process
                    */
                    bus: {
                        type: Object,
                        value: null
                    },
                    /**
                    * String with code on the editor
                    */
                    code: {
                        type: String,
                        value: null
                    },
                    /**
                    * Flag if app is trying to connect to a board
                    */
                    connecting: {
                        type: Boolean,
                        value: false
                    },
                    /**
                    * Flag if app is connected to a board
                    */
                    connected: {
                        type: Boolean,
                        value: false
                    },
                    /**
                    * Flag if app is running code
                    */
                    running: {
                        type: Boolean,
                        value: false
                    },
                    /**
                    * Flag if board is in raw REPL mode
                    */
                    rawRepl: {
                        type: Boolean,
                        value: false
                    },
                    /**
                    * Console output
                    */
                    consoleOut: {
                        type: String,
                        value: ''
                    },
                    /**
                    * Auto save timeout id
                    */
                    autosaveTimeout: {
                        type: Number,
                        value: 0
                    },
                    term: {
                        type: Object,
                        value: null
                    }
                }
            }
            connectedCallback() {
                super.connectedCallback()
                if (window.bus) {
                    this.set('bus', window.bus)
                } else {
                    this.set('bus', new window.MicroPythonIDE.EventEmitter())
                }

                Terminal.applyAddon(fit)
                this.set('term', new Terminal())
                this.term.open(Polymer.dom(this.root).querySelector('#console'))
                this.term.setOption('fontSize', 12)
                this.term.fit()
                this.term.write(`Welcome to MicroPythonIDE! :D`)
                this.term.on('key', (key, e) => {
                    this.sendChar(key)
                })

                this.bindEvents()
                this.loadAvailableDevices()
                this.loadCodeFromLocalStorage()
            }
            bindEvents() {
                this.bus.on('connected', () => {
                    this.set('connecting', false)
                    this.set('connected', true)
                })
                this.bus.on('disconnected', () => {
                    this.set('connecting', false)
                    this.set('connected', false)
                })
                this.bus.on('output', (data) => {
                    this.output(data)
                })
                this.bus.on('available-ports', (availablePorts) => {
                    this.set('availablePorts', availablePorts)
                })
                this.bus.on('load-code', (code) => {
                    this.set('code', code)
                })
                this.bus.on('raw-repl-started', () => {
                    this.set('rawRepl', true)
                    this.set('running', true)
                })
                this.bus.on('raw-repl-finished', () => {
                    this.set('rawRepl', false)
                    this.set('running', false)
                })
            }
            loadAvailableDevices() {
                this.bus.emit('load-available-devices')
            }
            loadCodeFromLocalStorage() {
                const code = localStorage.getItem('code')
                this.set('code', code)
            }
            output(msg) {
                this.term.write(msg)
            }
            computeAvailableDevices(ports) {
                if (!ports || !ports.base) {
                    return
                }
                return ports.base.filter((port) => {
                    return !!port.vendorId
                })
            }
            autosaveCode() {
                const code = this.$.code.value
                if (code && this.code != code) {
                    clearTimeout(this.autosaveTimeout)
                    this.autosaveTimeout = setTimeout(() => {
                        localStorage.setItem('code', code)
                    }, 2000)
                }
                this.set('code', code)
            }
            connect() {
                this.set('connecting', true)
                const select = Polymer.dom(this.root).querySelector('#serialPorts')
                if (select && select.value) {
                    this.bus.emit('connect', select.value)
                }
            }
            disconnect() {
                this.bus.emit('disconnect')
            }
            stop() {
                this.bus.emit('send-stop')
            }
            reset() {
                this.bus.emit('send-stop')
                this.bus.emit('send-reset')
            }
            execFromString(code) {
                this.bus.emit('exec-from-string', code)
            }
            sendChar(c) {
                if (this.connected) {
                    this.bus.emit('exec', c);
                }
            }
            run() {
                this.execFromString(this.code)
            }
            listFiles() {
                const code = `print(' ')
from os import listdir
print(listdir())
`
                this.execFromString(code)
            }
            openSaveDialog() {
                this.$.saveDialog.open()
            }
            openLoadDialog() {
                this.$.loadDialog.open()
            }
            openRemoveDialog() {
                this.$.removeDialog.open()
            }
            saveFile() {
                const filename = this.$.saveFilename.value
                if (filename && this.code) {
                    this._saveFile(this.$.saveFilename.value, this.code)
                    this.$.saveDialog.close()
                }
            }
            _saveFile(filename, code) {
                let pCode = `import binascii
f = open('${filename}', 'w')
`
                // `code` is what comes from the editor. We want to write its
                // line one by one on a file so we split by `\n`
                code.split('\n').forEach((line) => {
                    if (line) {
                        // To avoid the string escaping with weirdly we encode
                        // the line plus the `\n` that we just removed to base64
                        const l = Buffer.from(`${line}\n`).toString('base64')
                        pCode += `f.write(binascii.a2b_base64("${l}"))\n`
                    }
                })
                pCode += 'f.close()\n'
                this.execFromString(pCode)
            }
            loadFile() {
                const filename = this.$.loadFilename.value
                if (filename) {
                    this._loadFile(filename)
                    this.$.loadDialog.close()
                }
            }
            _loadFile(filename) {
                const pCode = `print(' ')
with open('${filename}', 'r') as f:
    for line in f.readlines():
        print(line.replace('\\n', ''))`
                this.execFromString(pCode)
            }
            removeFile() {
                const filename = this.$.removeFilename.value
                if (filename) {
                    this._removeFile(filename)
                    this.$.removeDialog.close()
                }
            }
            _removeFile(filename) {
                const pCode = `from os import remove
remove('${filename}')`
                this.execFromString(pCode)
            }
        };
        window.customElements.define(MicroPythonIDE.is, MicroPythonIDE)
    </script>
</dom-module>
